<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayPal Payee Test - One-time vs Vaulted</title>
    <link rel="stylesheet" type="text/css" href="/styles/custom.css" />
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section h3 {
            color: #0070ba;
            margin-top: 0;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        .btn {
            background-color: #0070ba;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .btn:hover {
            background-color: #005a94;
        }
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .results {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #28a745;
            background-color: #d4edda;
        }
        .error {
            border-left: 4px solid #dc3545;
            background-color: #f8d7da;
        }
        .warning {
            border-left: 4px solid #ffc107;
            background-color: #fff3cd;
        }
        .paypal-buttons {
            margin: 15px 0;
        }
        .explanation {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>PayPal Vault v3 Test: Payment Method Tokens</h1>
        
        <div class="explanation">
            <h4>Vault v3 Test Explanation:</h4>
            <p><strong>New Payment Method Token Format:</strong></p>
            <pre><code>"payment_source": {
    "token": {
        "id": "vault_id_from_previous_transaction",
        "type": "PAYMENT_METHOD_TOKEN"
    }
}</code></pre>
            <p><strong>Test Flow:</strong></p>
            <ul>
                <li><strong>Step 1:</strong> Create vaulted payment token (stores payment method)</li>
                <li><strong>Step 2:</strong> Use vault v3 token format with different payee merchant ID</li>
                <li><strong>Step 3:</strong> Compare vault v3 vs legacy vault behavior</li>
            </ul>
            <p>This tests PayPal's new vault v3 API format and security model.</p>
        </div>

        <!-- Configuration Section -->
        <div class="test-section">
            <h3>Test Configuration</h3>
            <div class="form-group">
                <label for="payee-merchant-id">Different Payee Merchant ID:</label>
                <input type="text" id="payee-merchant-id" placeholder="Enter different merchant ID for testing">
                <small>This should be a different PayPal merchant ID than your primary account</small>
            </div>
            <div class="form-group">
                <label for="test-amount">Test Amount (USD):</label>
                <input type="number" id="test-amount" value="10.00" step="0.01" min="1">
            </div>
        </div>

        <!-- Test 1: Create Vault Token -->
        <div class="test-section">
            <h3>Step 1: Create Vault Payment Token</h3>
            <p>First, create a vaulted payment token that we'll test with the vault v3 format.</p>
            <p><strong>Process:</strong> PayPal Button ‚Üí Login/Approval ‚Üí Vault Token Creation</p>
            
            <div id="paypal-button-container-vault"></div>
            
            <div id="vault-results" class="results" style="display: none;"></div>
            <div id="vault-token" style="display: none;"></div>
        </div>

        <!-- Test 2: Vault v3 Format Test -->
        <div class="test-section">
            <h3>Step 2: Test Vault v3 Payment Method Token Format</h3>
            <p>Test the new vault v3 format with <code>PAYMENT_METHOD_TOKEN</code> type.</p>
            <p><strong>API Format:</strong></p>
            <pre><code>{
  "payment_source": {
    "token": {
      "id": "your_vault_id",
      "type": "PAYMENT_METHOD_TOKEN"
    }
  }
}</code></pre>
            
            <button class="btn" id="test-vault-v3-btn" onclick="testVaultV3Format()" disabled>
                Test Vault v3 Format
            </button>
            
            <div id="vault-v3-results" class="results" style="display: none;"></div>
        </div>

        <!-- Test 3: Vault v3 with Different Payee -->
        <div class="test-section">
            <h3>Step 3: Test Vault v3 with Different Payee</h3>
            <p>Test vault v3 format with different payee merchant ID to verify security model.</p>
            <p><strong>Expected:</strong> Should work with same merchant, may fail with different payee.</p>
            
            <button class="btn" id="test-vault-v3-payee-btn" onclick="testVaultV3WithPayee()" disabled>
                Test Vault v3 with Different Payee
            </button>
            
            <div id="vault-v3-payee-results" class="results" style="display: none;"></div>
        </div>

        <!-- Test 4: Legacy vs v3 Comparison -->
        <div class="test-section">
            <h3>Step 4: Legacy Vault vs Vault v3 Comparison</h3>
            <p>Compare the old vault format with the new vault v3 format.</p>
            
            <button class="btn" id="test-legacy-comparison-btn" onclick="testLegacyVsV3()" disabled>
                Compare Legacy vs Vault v3
            </button>
            
            <div id="legacy-comparison-results" class="results" style="display: none;"></div>
        </div>

        <!-- Results Summary -->
        <div class="test-section">
            <h3>Test Results Summary</h3>
            <div id="summary-results" class="results">
                Ready to run tests...
            </div>
        </div>
    </div>

    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=<%= clientId %>&components=buttons&vault=true&intent=capture"></script>
    
    <script>
        let vaultedToken = null;
        let testResults = {
            vaultCreation: null,
            vaultV3: null,
            vaultV3Payee: null,
            legacyComparison: null
        };

        // Auto-fill the payee merchant ID field
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('payee-merchant-id').value = 'QA9TDBGQ8E5RS';
        });

        // Test vault v3 format
        function testVaultV3Format() {
            if (!vaultedToken) {
                alert('Please create a vaulted token first');
                return;
            }

            const amount = document.getElementById('test-amount').value;
            
            showResults('vault-v3-results', 'Testing vault v3 PAYMENT_METHOD_TOKEN format...', 'warning');

            fetch('/api/test-vault-v3', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    vaultedToken: vaultedToken,
                    amount: amount
                })
            })
            .then(response => response.json())
            .then(data => {
                testResults.vaultV3 = data;
                
                let resultMessage = `üß™ VAULT V3 FORMAT TEST RESULTS:\n\n`;
                
                if (data.success) {
                    resultMessage += `‚úÖ ORDER CREATION: SUCCESS\n`;
                    resultMessage += `Order ID: ${data.orderId}\n`;
                    resultMessage += `Status: ${data.status}\n`;
                    
                    if (data.capture && data.capture.success) {
                        resultMessage += `‚úÖ CAPTURE: SUCCESS\n`;
                        resultMessage += `Capture ID: ${data.capture.captureId}\n`;
                        resultMessage += `Amount: $${data.capture.amount}\n`;
                    } else if (data.capture && data.capture.error) {
                        resultMessage += `‚ùå CAPTURE: FAILED\n`;
                        resultMessage += `Error: ${data.capture.error}\n`;
                    }
                    
                    resultMessage += `\nüìã PAYMENT SOURCE FORMAT:\n`;
                    resultMessage += `{\n`;
                    resultMessage += `  "payment_source": {\n`;
                    resultMessage += `    "token": {\n`;
                    resultMessage += `      "id": "${vaultedToken}",\n`;
                    resultMessage += `      "type": "PAYMENT_METHOD_TOKEN"\n`;
                    resultMessage += `    }\n`;
                    resultMessage += `  }\n`;
                    resultMessage += `}\n\n`;
                    
                    showResults('vault-v3-results', resultMessage, 'success');
                } else {
                    resultMessage += `‚ùå ORDER CREATION: FAILED\n`;
                    resultMessage += `Error: ${data.error}\n\n`;
                    
                    showResults('vault-v3-results', resultMessage, 'error');
                }
                
                resultMessage += `üìä Full Response:\n${JSON.stringify(data, null, 2)}`;
                document.getElementById('vault-v3-results').textContent = resultMessage;
                
                document.getElementById('test-vault-v3-payee-btn').disabled = false;
                document.getElementById('test-legacy-comparison-btn').disabled = false;
                updateSummary();
            })
            .catch(error => {
                testResults.vaultV3 = { success: false, error: error.message };
                showResults('vault-v3-results', `‚ùå ERROR: ${error.message}`, 'error');
                updateSummary();
            });
        }

        // Test vault v3 format with different payee
        function testVaultV3WithPayee() {
            if (!vaultedToken) {
                alert('Please create a vaulted token first');
                return;
            }

            const payeeMerchantId = document.getElementById('payee-merchant-id').value;
            const amount = document.getElementById('test-amount').value;
            
            if (!payeeMerchantId) {
                alert('Please enter a different payee merchant ID');
                return;
            }

            showResults('vault-v3-payee-results', 'Testing vault v3 format with different payee...', 'warning');

            fetch('/api/test-vault-v3-payee', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    vaultedToken: vaultedToken,
                    payeeMerchantId: payeeMerchantId,
                    amount: amount
                })
            })
            .then(response => response.json())
            .then(data => {
                testResults.vaultV3Payee = data;
                
                let resultMessage = `üß™ VAULT V3 + DIFFERENT PAYEE TEST:\n\n`;
                
                if (data.success) {
                    resultMessage += `${data.orderCreation.success ? '‚úÖ' : '‚ùå'} ORDER CREATION: ${data.orderCreation.success ? 'SUCCESS' : 'FAILED'}\n`;
                    
                    if (data.orderCreation.success) {
                        resultMessage += `Order ID: ${data.orderId}\n`;
                        resultMessage += `Payee: ${payeeMerchantId}\n`;
                        
                        if (data.capture && data.capture.success) {
                            resultMessage += `‚úÖ CAPTURE: SUCCESS\n`;
                            resultMessage += `üí∞ Funds disbursed to different payee!\n`;
                        } else if (data.capture && data.capture.error) {
                            resultMessage += `‚ùå CAPTURE: FAILED\n`;
                            resultMessage += `Error: ${data.capture.error}\n`;
                        }
                    }
                    
                    showResults('vault-v3-payee-results', resultMessage, data.capture?.success ? 'success' : 'warning');
                } else {
                    resultMessage += `‚ùå ORDER CREATION: FAILED (Expected for security)\n`;
                    resultMessage += `Error: ${data.error}\n`;
                    resultMessage += `üîí Security: Vault tokens tied to original merchant\n`;
                    
                    showResults('vault-v3-payee-results', resultMessage, 'success');
                }
                
                resultMessage += `\nüìä Full Response:\n${JSON.stringify(data, null, 2)}`;
                document.getElementById('vault-v3-payee-results').textContent = resultMessage;
                
                updateSummary();
            })
            .catch(error => {
                testResults.vaultV3Payee = { success: false, error: error.message };
                showResults('vault-v3-payee-results', `‚úÖ EXPECTED: ${error.message}`, 'success');
                updateSummary();
            });
        }

        // Compare legacy vault vs vault v3
        function testLegacyVsV3() {
            if (!vaultedToken) {
                alert('Please create a vaulted token first');
                return;
            }

            const amount = document.getElementById('test-amount').value;
            
            showResults('legacy-comparison-results', 'Comparing legacy vault vs vault v3 formats...', 'warning');

            fetch('/api/test-legacy-vs-v3', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    vaultedToken: vaultedToken,
                    amount: amount
                })
            })
            .then(response => response.json())
            .then(data => {
                testResults.legacyComparison = data;
                
                let resultMessage = `üîÑ LEGACY vs VAULT V3 COMPARISON:\n\n`;
                
                // Legacy results
                resultMessage += `üìä LEGACY VAULT FORMAT:\n`;
                if (data.legacy.success) {
                    resultMessage += `‚úÖ Status: SUCCESS\n`;
                    resultMessage += `Order ID: ${data.legacy.orderId}\n`;
                    resultMessage += `Format: { "paypal": { "vault_id": "${vaultedToken}" } }\n`;
                } else {
                    resultMessage += `‚ùå Status: FAILED\n`;
                    resultMessage += `Error: ${data.legacy.error}\n`;
                }
                
                resultMessage += `\nüìä VAULT V3 FORMAT:\n`;
                if (data.v3.success) {
                    resultMessage += `‚úÖ Status: SUCCESS\n`;
                    resultMessage += `Order ID: ${data.v3.orderId}\n`;
                    resultMessage += `Format: { "token": { "id": "${vaultedToken}", "type": "PAYMENT_METHOD_TOKEN" } }\n`;
                } else {
                    resultMessage += `‚ùå Status: FAILED\n`;
                    resultMessage += `Error: ${data.v3.error}\n`;
                }
                
                resultMessage += `\nüéØ COMPARISON RESULTS:\n`;
                const bothWork = data.legacy.success && data.v3.success;
                const neitherWork = !data.legacy.success && !data.v3.success;
                const onlyLegacy = data.legacy.success && !data.v3.success;
                const onlyV3 = !data.legacy.success && data.v3.success;
                
                if (bothWork) {
                    resultMessage += `‚úÖ Both formats work - backward compatibility maintained\n`;
                } else if (neitherWork) {
                    resultMessage += `‚ùå Neither format works - possible API issues\n`;
                } else if (onlyLegacy) {
                    resultMessage += `‚ö†Ô∏è Only legacy format works - v3 may not be fully deployed\n`;
                } else if (onlyV3) {
                    resultMessage += `üÜï Only v3 format works - legacy deprecated\n`;
                }
                
                resultMessage += `\nüìä Full Response:\n${JSON.stringify(data, null, 2)}`;
                
                showResults('legacy-comparison-results', resultMessage, 'success');
                updateSummary();
            })
            .catch(error => {
                testResults.legacyComparison = { success: false, error: error.message };
                showResults('legacy-comparison-results', `‚ùå ERROR: ${error.message}`, 'error');
                updateSummary();
            });
        }

        // Vault setup token creation function
        const createVaultSetupToken = (data) => {
            const paymentSource = 'paypal';
            
            return fetch('/api/vault/setup-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    paymentSource
                })
            })
            .then(response => response.json())
            .then(setupTokenResponse => {
                console.log('Vault Setup Token Response:', setupTokenResponse);
                showResults('vault-results', `Vault setup token created: ${setupTokenResponse.id}`, 'warning');
                return setupTokenResponse.id;
            });
        };

        // Vault approval function
        const onVaultApprove = ({ vaultSetupToken }) => {
            showResults('vault-results', 'Creating vaulted payment token...', 'warning');
            
            return fetch(`/api/vault/payment-token/${vaultSetupToken}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(tokenData => {
                vaultedToken = tokenData.id;
                testResults.vaultCreation = { success: true, data: tokenData };
                
                document.getElementById('vault-token').style.display = 'block';
                document.getElementById('vault-token').innerHTML = `<strong>Vault Token ID:</strong> ${vaultedToken}`;
                
                // Enable vault v3 test buttons
                document.getElementById('test-vault-v3-btn').disabled = false;
                
                showResults('vault-results', `‚úÖ Vault token created successfully!\n\nToken ID: ${vaultedToken}\n\nüß™ Ready for vault v3 testing!\n\nFull Response:\n${JSON.stringify(tokenData, null, 2)}`, 'success');
                
                updateSummary();
                return tokenData;
            });
        };

        // PayPal Buttons for vaulting
        paypal.Buttons({
            createVaultSetupToken,
            onApprove: onVaultApprove,
            onError: function(err) {
                showResults('vault-results', `‚ùå Vaulting failed: ${err}`, 'error');
            }
        }).render('#paypal-button-container-vault');



        function showResults(elementId, message, type = 'warning') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = message;
            element.className = `results ${type}`;
        }

        function updateSummary() {
            let summary = 'üß™ PayPal Vault v3 Test Results:\n\n';
            
            if (testResults.vaultCreation !== null) {
                summary += `1Ô∏è‚É£ VAULT TOKEN CREATION:\n`;
                summary += `   Status: ${testResults.vaultCreation.success ? '‚úÖ SUCCESS' : '‚ùå FAILED'}\n`;
                summary += `   Token ID: ${vaultedToken || 'N/A'}\n\n`;
            }
            
            if (testResults.vaultV3 !== null) {
                summary += `2Ô∏è‚É£ VAULT V3 FORMAT TEST:\n`;
                summary += `   Status: ${testResults.vaultV3.success ? '‚úÖ SUCCESS' : '‚ùå FAILED'}\n`;
                summary += `   API Format: PAYMENT_METHOD_TOKEN\n`;
                
                if (testResults.vaultV3.success && testResults.vaultV3.capture) {
                    summary += `   Capture: ${testResults.vaultV3.capture.success ? '‚úÖ SUCCESS' : '‚ùå FAILED'}\n`;
                }
                summary += '\n';
            }
            
            if (testResults.vaultV3Payee !== null) {
                summary += `3Ô∏è‚É£ VAULT V3 + DIFFERENT PAYEE:\n`;
                summary += `   Order Creation: ${testResults.vaultV3Payee.success ? '‚ùå UNEXPECTED SUCCESS' : '‚úÖ EXPECTED FAILURE'}\n`;
                
                if (testResults.vaultV3Payee.success && testResults.vaultV3Payee.capture) {
                    summary += `   Capture: ${testResults.vaultV3Payee.capture.success ? 'üö® SECURITY ISSUE' : '‚úÖ BLOCKED'}\n`;
                    summary += `   Security: ${testResults.vaultV3Payee.capture.success ? '‚ùå COMPROMISED' : '‚úÖ PROTECTED'}\n`;
                } else {
                    summary += `   Security: ‚úÖ Vault tokens properly tied to original merchant\n`;
                }
                summary += '\n';
            }
            
            if (testResults.legacyComparison !== null) {
                summary += `4Ô∏è‚É£ LEGACY vs VAULT V3 COMPARISON:\n`;
                const legacy = testResults.legacyComparison.legacy;
                const v3 = testResults.legacyComparison.v3;
                
                summary += `   Legacy Format: ${legacy?.success ? '‚úÖ WORKS' : '‚ùå FAILED'}\n`;
                summary += `   Vault v3 Format: ${v3?.success ? '‚úÖ WORKS' : '‚ùå FAILED'}\n`;
                
                const bothWork = legacy?.success && v3?.success;
                const neitherWork = !legacy?.success && !v3?.success;
                const onlyLegacy = legacy?.success && !v3?.success;
                const onlyV3 = !legacy?.success && v3?.success;
                
                if (bothWork) {
                    summary += `   Compatibility: ‚úÖ Both formats supported\n`;
                } else if (neitherWork) {
                    summary += `   Compatibility: ‚ùå Neither format works\n`;
                } else if (onlyLegacy) {
                    summary += `   Compatibility: ‚ö†Ô∏è Only legacy works\n`;
                } else if (onlyV3) {
                    summary += `   Compatibility: üÜï Only v3 works\n`;
                }
                summary += '\n';
            }
            
            // Overall assessment
            const hasVaultV3Results = testResults.vaultV3 !== null && testResults.vaultV3Payee !== null;
            if (hasVaultV3Results) {
                const v3Works = testResults.vaultV3.success;
                const securityMaintained = !testResults.vaultV3Payee.success || 
                    (testResults.vaultV3Payee.success && !testResults.vaultV3Payee.capture?.success);
                
                summary += `üéØ VAULT V3 ASSESSMENT:\n`;
                summary += `   API Functionality: ${v3Works ? '‚úÖ WORKING' : '‚ùå NOT WORKING'}\n`;
                summary += `   Security Model: ${securityMaintained ? '‚úÖ MAINTAINED' : 'üö® COMPROMISED'}\n`;
                summary += `   Ready for Production: ${v3Works && securityMaintained ? '‚úÖ YES' : '‚ùå NO'}`;
            }
            
            const summaryType = hasVaultV3Results ? 'success' : 'warning';
            showResults('summary-results', summary, summaryType);
        }
    </script>
</body>
</html>